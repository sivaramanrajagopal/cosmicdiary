name: Event Collection with Cosmic State - Every 2 Hours

on:
  schedule:
    # Run every 2 hours at :30 past the hour (e.g., 00:30, 02:30, 04:30, ...)
    - cron: '30 */2 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  collect-events:
    name: Collect Events and Capture Cosmic State
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install openai supabase python-dotenv pyswisseph pytz timezonefinder
      
      - name: Run event collection with cosmic state
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          python collect_events_with_cosmic_state.py
        continue-on-error: false
      
      - name: Report Success Statistics
        if: success()
        run: |
          echo "âœ“ Cosmic state captured and events processed successfully"
          echo "Check workflow logs for detailed statistics"
          # Future: Add Slack/Discord webhook notification here
      
      - name: Upload logs artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: event-collection-logs-${{ github.run_id }}
          path: |
            *.log
          retention-days: 7
      
      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'ðŸš¨ Cosmic State Collection Failed';
            const body = `Cosmic state collection and event detection job failed at ${new Date().toISOString()}\n\n` +
                         `This means we missed capturing the planetary state for this 2-hour window.\n\n` +
                         `Check logs: ${context.payload.repository.html_url}/actions/runs/${context.runId}`;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['bug', 'automation']
            });

